<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .stage-cell {
        width: 18px;
        height: 14px;
        border-radius: 2px;
        flex-shrink: 0;
        transition: opacity 0.1s;
      }
      .task-desc-input {
        background: #374151;
        color: #f3f4f6;
        border: 1px solid #6b7280;
        border-radius: 4px;
        padding: 1px 6px;
        font-size: 0.875rem;
        width: 100%;
        outline: none;
      }
      .task-desc-input:focus {
        border-color: #3b82f6;
      }
      .stage-picker {
        position: absolute;
        z-index: 50;
        top: calc(100% + 4px);
        left: 0;
        background: #1f2937;
        border: 1px solid #4b5563;
        border-radius: 6px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        padding: 4px;
        min-width: 150px;
        display: flex;
        flex-direction: column;
        gap: 1px;
      }
      .stage-picker-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        text-align: left;
        cursor: pointer;
        color: #d1d5db;
        background: transparent;
        border: none;
        width: 100%;
      }
      .stage-picker-btn:hover {
        background: #374151;
      }
      .stage-picker-btn.active {
        background: #374151;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen" style="font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', monospace;">
    <!-- Header -->
    <header class="sticky top-0 z-10 bg-gray-950 border-b border-gray-700 px-4 py-3 flex items-center gap-3 flex-wrap" style="background:#030712;">
      <h1 class="font-bold text-white text-base">Task Tracker</h1>
      <span id="dir-label" class="text-gray-500 text-xs truncate flex-1" style="min-width:0;"></span>
      <div class="flex items-center gap-2 flex-shrink-0">
        <label class="text-xs text-gray-500" for="tz-select">TZ:</label>
        <select id="tz-select" class="bg-gray-800 text-gray-300 text-xs rounded px-2 py-1 border border-gray-700 focus:outline-none focus:border-blue-500"></select>
      </div>
      <button onclick="loadTasks()" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded flex-shrink-0">â†» Refresh</button>
    </header>

    <!-- Main -->
    <main class="max-w-5xl mx-auto px-4 py-6 space-y-6" id="main">
      <p class="text-gray-500 text-sm text-center py-16">Loading...</p>
    </main>

    <script>
      // Injected by server
      const GUI_DIR = __GUI_DIR__;

      const STAGES = [
        'pending','in-progress','implemented','verified','committed',
        'pushed','pr-created','merged','released','published','done'
      ];

      const STAGE_COLORS = {
        'pending':     '#6b7280',
        'in-progress': '#3b82f6',
        'implemented': '#06b6d4',
        'verified':    '#eab308',
        'committed':   '#a855f7',
        'pushed':      '#22c55e',
        'pr-created':  '#84cc16',
        'merged':      '#16a34a',
        'released':    '#38bdf8',
        'published':   '#4ade80',
        'done':        '#374151',
      };

      // â”€â”€ Timezone setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const tzSelect = document.getElementById('tz-select');
      let currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;

      try {
        const zones = Intl.supportedValuesOf('timeZone');
        zones.forEach(tz => {
          const opt = document.createElement('option');
          opt.value = tz;
          opt.textContent = tz;
          if (tz === currentTz) opt.selected = true;
          tzSelect.appendChild(opt);
        });
      } catch {
        const opt = document.createElement('option');
        opt.value = currentTz;
        opt.textContent = currentTz;
        opt.selected = true;
        tzSelect.appendChild(opt);
      }

      tzSelect.addEventListener('change', () => {
        currentTz = tzSelect.value;
        renderAll(lastData);
      });

      document.getElementById('dir-label').textContent = GUI_DIR;

      // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function formatDate(iso) {
        if (!iso) return '';
        try {
          return new Date(iso).toLocaleString(undefined, {
            timeZone: currentTz,
            dateStyle: 'short',
            timeStyle: 'short',
          });
        } catch {
          return iso;
        }
      }

      function stageIndex(stage) {
        return STAGES.indexOf(stage);
      }

      // â”€â”€ Stage gauge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let activeDropdown = null;

      function makeGauge(task, repoDir) {
        const idx = stageIndex(task.stage);
        const wrap = document.createElement('div');
        wrap.style.cssText = 'position:relative; display:inline-flex; gap:2px; cursor:pointer;';
        wrap.title = 'Click to change stage';

        STAGES.forEach((s, i) => {
          const cell = document.createElement('div');
          cell.className = 'stage-cell';
          cell.style.backgroundColor = STAGE_COLORS[s];
          cell.style.opacity = i <= idx ? '1' : '0.15';
          cell.title = s;
          wrap.appendChild(cell);
        });

        wrap.addEventListener('click', (e) => {
          e.stopPropagation();
          showStagePicker(wrap, task, repoDir);
        });

        return wrap;
      }

      function showStagePicker(anchor, task, repoDir) {
        if (activeDropdown) {
          activeDropdown.remove();
          activeDropdown = null;
        }

        const picker = document.createElement('div');
        picker.className = 'stage-picker';

        STAGES.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'stage-picker-btn' + (s === task.stage ? ' active' : '');

          const dot = document.createElement('span');
          dot.style.cssText = `display:inline-block;width:8px;height:8px;border-radius:50%;background:${STAGE_COLORS[s]};flex-shrink:0;`;

          const label = document.createElement('span');
          label.textContent = s;
          if (s === task.stage) label.style.color = STAGE_COLORS[s];

          btn.appendChild(dot);
          btn.appendChild(label);

          btn.addEventListener('click', async () => {
            picker.remove();
            activeDropdown = null;
            await fetch(`/api/tasks/${task.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dir: repoDir, stage: s }),
            });
            loadTasks();
          });

          picker.appendChild(btn);
        });

        anchor.appendChild(picker);
        activeDropdown = picker;

        const closeHandler = (e) => {
          if (!picker.contains(e.target)) {
            picker.remove();
            if (activeDropdown === picker) activeDropdown = null;
            document.removeEventListener('click', closeHandler);
          }
        };
        setTimeout(() => document.addEventListener('click', closeHandler), 0);
      }

      // â”€â”€ Task row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function makeTaskRow(task, repoDir) {
        const row = document.createElement('div');
        row.style.cssText = 'background:#1f2937;border:1px solid #374151;border-radius:6px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;';

        // Top row: gauge + stage badge + delete button
        const topRow = document.createElement('div');
        topRow.style.cssText = 'display:flex;align-items:center;gap:8px;flex-wrap:wrap;';

        const gauge = makeGauge(task, repoDir);

        const stageBadge = document.createElement('span');
        stageBadge.style.cssText = `font-size:0.7rem;padding:1px 6px;border-radius:4px;background:${STAGE_COLORS[task.stage]}22;color:${STAGE_COLORS[task.stage]};border:1px solid ${STAGE_COLORS[task.stage]}44;flex-shrink:0;`;
        stageBadge.textContent = task.stage;

        const spacer = document.createElement('div');
        spacer.style.flex = '1';

        const deleteBtn = document.createElement('button');
        deleteBtn.style.cssText = 'color:#6b7280;font-size:1rem;line-height:1;padding:0 4px;background:none;border:none;cursor:pointer;flex-shrink:0;';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.title = 'Delete task';
        deleteBtn.onmouseenter = () => { deleteBtn.style.color = '#f87171'; };
        deleteBtn.onmouseleave = () => { deleteBtn.style.color = '#6b7280'; };
        deleteBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (confirm(`Delete task "${task.description}"?`)) {
            await fetch(`/api/tasks/${task.id}?dir=${encodeURIComponent(repoDir)}`, { method: 'DELETE' });
            loadTasks();
          }
        });

        topRow.appendChild(gauge);
        topRow.appendChild(stageBadge);
        topRow.appendChild(spacer);
        topRow.appendChild(deleteBtn);

        // Description row
        const descEl = document.createElement('span');
        descEl.style.cssText = 'font-size:0.875rem;color:#f3f4f6;cursor:pointer;display:block;';
        descEl.textContent = task.description;
        descEl.title = 'Click to edit description';
        descEl.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = task.description;
          input.className = 'task-desc-input';
          descEl.replaceWith(input);
          input.focus();
          input.select();
          const save = async () => {
            const newDesc = input.value.trim();
            if (newDesc && newDesc !== task.description) {
              await fetch(`/api/tasks/${task.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dir: repoDir, description: newDesc }),
              });
            }
            loadTasks();
          };
          input.addEventListener('blur', save);
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
            if (e.key === 'Escape') { loadTasks(); }
          });
        });

        // Meta row
        const meta = document.createElement('div');
        meta.style.cssText = 'font-size:0.7rem;color:#6b7280;';
        meta.textContent = `#${task.id} Â· created ${formatDate(task.createdAt)} Â· updated ${formatDate(task.updatedAt)}`;

        row.appendChild(topRow);
        row.appendChild(descEl);
        row.appendChild(meta);

        return row;
      }

      // â”€â”€ Add-task form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function toggleAddForm(sectionEl, info) {
        let formDiv = sectionEl.querySelector('.add-form-container');

        if (formDiv && !formDiv.classList.contains('hidden')) {
          formDiv.classList.add('hidden');
          formDiv.innerHTML = '';
          return;
        }

        if (!formDiv) {
          formDiv = document.createElement('div');
          formDiv.className = 'add-form-container';
          formDiv.style.cssText = 'border-bottom:1px solid #374151;padding:12px 16px;background:#0f172a;';
          const header = sectionEl.querySelector('.section-header');
          header.insertAdjacentElement('afterend', formDiv);
        } else {
          formDiv.classList.remove('hidden');
          formDiv.innerHTML = '';
        }

        const form = document.createElement('div');
        form.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;align-items:center;';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Task description...';
        input.style.cssText = 'flex:1;min-width:180px;background:#374151;color:#f3f4f6;border:1px solid #6b7280;border-radius:4px;padding:6px 10px;font-size:0.875rem;outline:none;';
        input.addEventListener('focus', () => { input.style.borderColor = '#3b82f6'; });
        input.addEventListener('blur', () => { input.style.borderColor = '#6b7280'; });

        const stageSelect = document.createElement('select');
        stageSelect.style.cssText = 'background:#374151;color:#d1d5db;border:1px solid #6b7280;border-radius:4px;padding:6px 8px;font-size:0.875rem;outline:none;';
        STAGES.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          if (s === 'pending') opt.selected = true;
          stageSelect.appendChild(opt);
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add';
        addBtn.style.cssText = 'background:#2563eb;color:#fff;border:none;border-radius:4px;padding:6px 14px;font-size:0.875rem;cursor:pointer;flex-shrink:0;';
        addBtn.onmouseenter = () => { addBtn.style.background = '#1d4ed8'; };
        addBtn.onmouseleave = () => { addBtn.style.background = '#2563eb'; };

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.cssText = 'background:#374151;color:#d1d5db;border:none;border-radius:4px;padding:6px 14px;font-size:0.875rem;cursor:pointer;flex-shrink:0;';
        cancelBtn.onmouseenter = () => { cancelBtn.style.background = '#4b5563'; };
        cancelBtn.onmouseleave = () => { cancelBtn.style.background = '#374151'; };

        const doAdd = async () => {
          const desc = input.value.trim();
          if (!desc) { input.focus(); return; }
          await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dir: info.dir, description: desc, stage: stageSelect.value }),
          });
          formDiv.classList.add('hidden');
          formDiv.innerHTML = '';
          loadTasks();
        };

        addBtn.addEventListener('click', doAdd);
        cancelBtn.addEventListener('click', () => {
          formDiv.classList.add('hidden');
          formDiv.innerHTML = '';
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') doAdd();
          if (e.key === 'Escape') cancelBtn.click();
        });

        form.appendChild(input);
        form.appendChild(stageSelect);
        form.appendChild(addBtn);
        form.appendChild(cancelBtn);
        formDiv.appendChild(form);
        setTimeout(() => input.focus(), 0);
      }

      // â”€â”€ Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function makeSection(info, isRoot) {
        const section = document.createElement('div');
        section.style.cssText = 'background:#1f2937;border:1px solid #374151;border-radius:8px;overflow:hidden;';

        // Header
        const header = document.createElement('div');
        header.className = 'section-header';
        header.style.cssText = 'display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #374151;background:#111827;flex-wrap:wrap;';

        const icon = isRoot ? 'ðŸ“' : 'ðŸ“¦';
        const title = document.createElement('h2');
        title.style.cssText = 'font-weight:700;font-size:0.875rem;color:#f9fafb;flex-shrink:0;';
        title.textContent = `${icon} ${info.name}${isRoot ? ' (root)' : ''}`;

        const activeTasks = info.tasks.filter(t => t.stage !== 'done');
        const doneTasks = info.tasks.filter(t => t.stage === 'done');

        const count = document.createElement('span');
        count.style.cssText = 'font-size:0.75rem;color:#9ca3af;flex:1;';
        count.textContent = `${activeTasks.length} active / ${info.tasks.length} total`;

        const purgeBtn = document.createElement('button');
        purgeBtn.textContent = 'Purge done';
        purgeBtn.style.cssText = `font-size:0.75rem;padding:4px 10px;border-radius:4px;border:none;cursor:pointer;flex-shrink:0;background:${doneTasks.length > 0 ? '#374151' : '#1f2937'};color:${doneTasks.length > 0 ? '#d1d5db' : '#6b7280'};`;
        purgeBtn.disabled = doneTasks.length === 0;
        if (doneTasks.length > 0) {
          purgeBtn.onmouseenter = () => { purgeBtn.style.background = '#7f1d1d'; purgeBtn.style.color = '#fca5a5'; };
          purgeBtn.onmouseleave = () => { purgeBtn.style.background = '#374151'; purgeBtn.style.color = '#d1d5db'; };
        }
        purgeBtn.addEventListener('click', async () => {
          if (confirm(`Purge ${doneTasks.length} done task(s) from "${info.name}"?`)) {
            await fetch('/api/tasks/purge', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ dir: info.dir }),
            });
            loadTasks();
          }
        });

        const addBtn = document.createElement('button');
        addBtn.textContent = '+ Add task';
        addBtn.style.cssText = 'font-size:0.75rem;padding:4px 10px;border-radius:4px;border:none;cursor:pointer;flex-shrink:0;background:#1d4ed8;color:#fff;';
        addBtn.onmouseenter = () => { addBtn.style.background = '#1e40af'; };
        addBtn.onmouseleave = () => { addBtn.style.background = '#1d4ed8'; };
        addBtn.addEventListener('click', () => toggleAddForm(section, info));

        header.appendChild(title);
        header.appendChild(count);
        header.appendChild(purgeBtn);
        header.appendChild(addBtn);

        // Task list
        const taskList = document.createElement('div');
        taskList.style.cssText = 'padding:12px;display:flex;flex-direction:column;gap:8px;';

        if (info.tasks.length === 0) {
          const empty = document.createElement('p');
          empty.style.cssText = 'color:#6b7280;font-size:0.875rem;text-align:center;padding:24px 0;';
          empty.textContent = 'No tasks. Click "+ Add task" to create one.';
          taskList.appendChild(empty);
        } else {
          // Active tasks first (sorted by updatedAt desc), then done
          const sorted = [...info.tasks].sort((a, b) => {
            if (a.stage === 'done' && b.stage !== 'done') return 1;
            if (a.stage !== 'done' && b.stage === 'done') return -1;
            return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime();
          });
          sorted.forEach(task => taskList.appendChild(makeTaskRow(task, info.dir)));
        }

        section.appendChild(header);
        section.appendChild(taskList);
        return section;
      }

      // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let lastData = null;

      function renderAll(data) {
        if (!data) return;
        lastData = data;
        const main = document.getElementById('main');
        main.innerHTML = '';

        if (data.root) {
          main.appendChild(makeSection(data.root, true));
        }

        if (data.repos && data.repos.length > 0) {
          data.repos.forEach(repo => main.appendChild(makeSection(repo, false)));
        }

        if (!data.root && (!data.repos || data.repos.length === 0)) {
          const empty = document.createElement('div');
          empty.style.cssText = 'text-align:center;padding:64px 0;color:#6b7280;';
          empty.innerHTML = `
            <p style="font-size:1.125rem;margin-bottom:8px;">No .tasks.jsonl files found</p>
            <p style="font-size:0.875rem;">Run <code style="background:#1f2937;padding:1px 6px;border-radius:3px;">task-tracker add "task"</code> in a git repo to get started</p>
          `;
          main.appendChild(empty);
        }
      }

      // â”€â”€ Data fetching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function loadTasks() {
        try {
          const res = await fetch(`/api/tasks?dir=${encodeURIComponent(GUI_DIR)}`);
          if (res.ok) {
            const data = await res.json();
            renderAll(data);
          }
        } catch (e) {
          console.error('Failed to load tasks:', e);
        }
      }

      loadTasks();
      setInterval(() => {
        // Skip auto-refresh when user is typing to prevent losing input and focus
        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'SELECT')) return;
        loadTasks();
      }, 5000);
    </script>
  </body>
</html>
